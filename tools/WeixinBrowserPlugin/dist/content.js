window.__SENPARC_DEBUG__={enabled:!1,level:"error",trigger:"senparc-debug"};class WeixinAIAssistant{constructor(){this.logoButton=null,this.floatingWindow=null,this.isWindowOpen=!1,this.isDocked=!1,this.originalBodyStyle="",this.debug=window.__SENPARC_DEBUG__||{enabled:!1,level:"error",trigger:"senparc-debug"},this.init()}log(t,...i){(this.debug.enabled||window.location.href.includes(this.debug.trigger))&&("verbose"===this.debug.level||"info"===this.debug.level&&"verbose"!==t||"warn"===this.debug.level&&("warn"===t||"error"===t)||this.debug.level)}init(){this.log("info","Senparc.Weixin.AI 插件开始初始化..."),this.log("verbose","当前页面URL:",window.location.href),this.log("verbose","当前域名:",window.location.hostname),this.isWeixinDocPage()?(this.log("info","✅ 检测到微信文档页面，初始化AI助手..."),this.createLogoButton(),this.setupEventListeners()):(this.log("warn","❌ 当前页面不在支持列表中"),this.log("info","仅支持以下页面:"),this.log("info","  - https://developers.weixin.qq.com/"),this.log("info","  - https://developer.work.weixin.qq.com/document"),this.log("info","  - https://pay.weixin.qq.com/doc"))}isWeixinDocPage(){const t=window.location.href,i=window.location.hostname,o=["developers.weixin.qq.com","developer.work.weixin.qq.com","pay.weixin.qq.com"].some(t=>i===t);return"developer.work.weixin.qq.com"===i?t.includes("/document"):"pay.weixin.qq.com"===i?t.includes("/doc"):o}createLogoButton(){const t=document.getElementById("senparc-weixin-ai-button");t&&t.remove(),this.logoButton=document.createElement("div"),this.logoButton.id="senparc-weixin-ai-button",this.logoButton.className="senparc-ai-logo-button",this.logoButton.innerHTML='\n      <div class="logo-content">\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n        </svg>\n        <span class="logo-text">Senparc.Weixin.AI</span>\n      </div>\n    ',document.body.appendChild(this.logoButton),this.setupDragFeature()}setupDragFeature(){if(!this.logoButton)return;let t,i,o,e,n,s,a=!1,l=!1,r=0,d=0,c=0;const h=localStorage.getItem("senparcAiButtonPosition");if(h)try{const{x:t,y:i}=JSON.parse(h);this.logoButton.style.left=t+"px",this.logoButton.style.top=i+"px",d=t,c=i}catch(t){}const g=d=>{if(d.target===this.logoButton||this.logoButton.contains(d.target)){a=!0,l=!1,r=Date.now(),o=this.logoButton.offsetWidth,e=this.logoButton.offsetHeight,n=window.innerWidth-o,s=window.innerHeight-e;const c=parseInt(this.logoButton.style.left)||0,h=parseInt(this.logoButton.style.top)||0;"mousedown"===d.type?(t=d.clientX-c,i=d.clientY-h):(t=d.touches[0].clientX-c,i=d.touches[0].clientY-h),this.logoButton.classList.add("dragging"),this.logoButton.style.cursor="grabbing",d.preventDefault(),d.stopPropagation()}},u=t=>{if(!a)return;const i=Date.now()-r;a=!1,this.logoButton.classList.remove("dragging"),this.logoButton.style.cursor="grab",(l||i>200)&&(t.preventDefault(),t.stopPropagation(),this.logoButton.setAttribute("data-just-dragged","true"),setTimeout(()=>{this.logoButton.removeAttribute("data-just-dragged")},100),this._savePositionTimeout&&clearTimeout(this._savePositionTimeout),this._savePositionTimeout=setTimeout(()=>{localStorage.setItem("senparcAiButtonPosition",JSON.stringify({x:d,y:c}))},500))},p=o=>{if(!a)return;o.preventDefault(),o.stopPropagation();const e="mousemove"===o.type?o.clientX:o.touches[0].clientX,r="mousemove"===o.type?o.clientY:o.touches[0].clientY;let h=Math.min(Math.max(0,e-t),n),g=Math.min(Math.max(0,r-i),s);!l&&(Math.abs(h-d)>5||Math.abs(g-c)>5)&&(l=!0),h!==d&&(this.logoButton.style.left=h+"px",d=h),g!==c&&(this.logoButton.style.top=g+"px",c=g)};this.logoButton.addEventListener("mousedown",g,{capture:!0}),document.addEventListener("mousemove",p,{capture:!0}),document.addEventListener("mouseup",u,{capture:!0}),this.logoButton.addEventListener("touchstart",g,{capture:!0,passive:!1}),document.addEventListener("touchmove",p,{capture:!0,passive:!1}),document.addEventListener("touchend",u,{capture:!0}),this.logoButton.style.position="fixed",this.logoButton.style.cursor="grab",this.logoButton.style.userSelect="none",this.logoButton.style.zIndex="10000",this.logoButton.style.touchAction="none"}setupEventListeners(){if(this.logoButton){this.logoButton.onclick=null;const t=t=>{"true"!==this.logoButton.getAttribute("data-just-dragged")&&(t.preventDefault(),t.stopPropagation(),this.toggleFloatingWindow())};this.logoButton.addEventListener("click",t,{capture:!0})}document.addEventListener("keydown",t=>{"Escape"===t.key&&this.isWindowOpen&&this.closeFloatingWindow()}),document.addEventListener("click",t=>{this.isWindowOpen&&this.floatingWindow&&!this.floatingWindow.contains(t.target)&&!this.logoButton.contains(t.target)&&this.closeFloatingWindow()})}toggleFloatingWindow(){this.isWindowOpen?this.closeFloatingWindow():this.openFloatingWindow()}openFloatingWindow(){if(this.floatingWindow){this.floatingWindow.style.display="flex",this.floatingWindow.style.opacity="1",this.floatingWindow.style.visibility="visible",this.floatingWindow.classList.add("floating-mode"),this.isWindowOpen=!0;const t=this.floatingWindow.querySelector("#senparc-ai-iframe"),i=this.floatingWindow.querySelector(".loading-indicator");if(t){t.style.cssText="\n          width: 100% !important;\n          height: 100% !important;\n          border: none;\n          display: block !important;\n          min-height: 500px;\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n        ";const i=t.parentElement;if(i){const o=i.offsetHeight,e=i.offsetWidth;t.style.width=e+"px",t.style.height=o+"px"}t.style.opacity="0",setTimeout(()=>{t.style.opacity="1"},50)}return i&&(i.style.display="none"),this.setupButtonEvents(),void requestAnimationFrame(()=>{this.floatingWindow&&(this.floatingWindow.classList.add("show"),setTimeout(()=>{this.recalculateIframeSize()},350))})}this.floatingWindow=document.createElement("div"),this.floatingWindow.id="senparc-weixin-ai-window",this.floatingWindow.className="senparc-ai-floating-window";const t=encodeURIComponent(window.location.href);this.floatingWindow.innerHTML=`\n      <div class="floating-window-header">\n        <div class="window-title">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          </svg>\n          Senparc.Weixin.AI 助手\n        </div>\n        <div class="window-controls">\n          <button class="dock-button" id="dock-toggle-button" title="停靠/悬浮切换">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n              <path d="M9 3v18" stroke="currentColor" stroke-width="2"/>\n            </svg>\n          </button>\n          <button class="close-button" id="close-floating-window">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n      <div class="floating-window-content">\n        <div class="loading-indicator">\n          <div class="spinner"></div>\n          <p>正在加载AI助手...</p>\n        </div>\n        <iframe \n          id="senparc-ai-iframe" \n          src="https://sdk.weixin.senparc.com/AiDoc?query=${t}" \n          frameborder="0"\n          allow="clipboard-read; clipboard-write"\n          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation">\n        </iframe>\n      </div>\n      <div class="floating-window-footer">\n        <span class="footer-text">Powered by Senparc.Weixin SDK</span>\n      </div>\n    `,document.body.appendChild(this.floatingWindow),this.floatingWindow.classList.add("floating-mode"),this.setupButtonEvents();const i=new ResizeObserver(()=>{this.recalculateIframeSize()}),o=this.floatingWindow.querySelector(".floating-window-content");o&&i.observe(o);const e=this.floatingWindow.querySelector("#senparc-ai-iframe");e.addEventListener("load",()=>{const t=this.floatingWindow.querySelector(".loading-indicator");t&&(t.style.display="none"),e.style.display="block",setTimeout(()=>{this.recalculateIframeSize()},100)}),e.addEventListener("error",()=>{const t=this.floatingWindow.querySelector(".loading-indicator");t&&(t.innerHTML='\n          <div class="error-message">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>\n              <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n            <p>加载失败，请检查网络连接</p>\n            <button onclick="location.reload()" class="retry-button">重试</button>\n          </div>\n        ')}),this.isWindowOpen=!0,setTimeout(()=>{this.floatingWindow.classList.add("show")},10)}setupButtonEvents(){this.floatingWindow&&(this.bindButtonEvents(),this.isButtonEventsBound()||setTimeout(()=>{this.bindButtonEvents()},50))}isButtonEventsBound(){const t=this.floatingWindow?.querySelector("#close-floating-window");return t&&"function"==typeof t.onclick}bindButtonEvents(){if(!this.floatingWindow)return;const t=this.floatingWindow.querySelector("#close-floating-window");if(!t)return void setTimeout(()=>{this.bindButtonEvents()},200);{const i=t=>{t&&(t.preventDefault(),t.stopPropagation());try{this.closeFloatingWindow()}catch(t){}return!1};t.onclick=i,t.addEventListener("click",i,{capture:!0,once:!1}),t.addEventListener("mousedown",t=>{t.preventDefault(),setTimeout(()=>i(t),10)}),t.style.cssText="\n        pointer-events: auto !important;\n        cursor: pointer !important;\n        z-index: 10003 !important;\n        position: relative !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border: none !important;\n        border-radius: 8px !important;\n        width: 32px !important;\n        height: 32px !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        color: white !important;\n      ",t.setAttribute("data-event-bound","true"),t.setAttribute("data-bind-time",Date.now().toString())}const i=this.floatingWindow.querySelector("#dock-toggle-button");if(i){const t=t=>{t&&(t.preventDefault(),t.stopPropagation());try{this.toggleDockMode()}catch(t){}return!1};i.onclick=t,i.addEventListener("click",t,{capture:!0}),i.style.cssText="\n        pointer-events: auto !important;\n        cursor: pointer !important;\n        z-index: 10003 !important;\n        position: relative !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border: none !important;\n        border-radius: 8px !important;\n        width: 32px !important;\n        height: 32px !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        color: white !important;\n        margin-right: 4px !important;\n      "}}toggleDockMode(){this.isDocked?this.setFloatingMode():this.setDockMode()}setDockMode(){this.floatingWindow&&(this.originalBodyStyle=document.body.className,this.floatingWindow.classList.remove("show","floating-mode"),this.floatingWindow.style.transform="none !important",this.floatingWindow.style.left="auto !important",this.floatingWindow.style.top="0 !important",this.floatingWindow.style.right="0 !important",this.floatingWindow.style.width="40% !important",this.floatingWindow.style.height="100vh !important",this.floatingWindow.style.maxWidth="none !important",this.floatingWindow.style.maxHeight="none !important",this.floatingWindow.style.minHeight="100vh !important",this.floatingWindow.style.borderRadius="0 !important",this.floatingWindow.style.position="fixed !important",this.floatingWindow.style.display="flex !important",this.floatingWindow.style.opacity="1 !important",this.floatingWindow.style.visibility="visible !important",this.floatingWindow.style.zIndex="10000 !important",this.floatingWindow.classList.add("docked-mode"),requestAnimationFrame(()=>{this.floatingWindow.classList.add("show")}),document.body.classList.add("senparc-docked"),document.body.style.marginRight="40%",document.body.style.transition="margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.boxSizing="border-box",document.body.style.overflowX="hidden",this.applyWeixinDocsSpecificStyles(),this.updateDockButtonIcon(!0),this.isDocked=!0,this.isWindowOpen=!0,setTimeout(()=>{this.recalculateIframeSize()},100))}setFloatingMode(){this.floatingWindow&&(this.floatingWindow.style.display="flex !important",this.floatingWindow.style.opacity="1 !important",this.floatingWindow.style.visibility="visible !important",this.floatingWindow.classList.remove("docked-mode"),this.floatingWindow.style.transform="",this.floatingWindow.style.left="",this.floatingWindow.style.top="",this.floatingWindow.style.right="",this.floatingWindow.style.width="",this.floatingWindow.style.height="",this.floatingWindow.style.maxWidth="",this.floatingWindow.style.maxHeight="",this.floatingWindow.style.minHeight="",this.floatingWindow.style.borderRadius="",this.floatingWindow.style.position="",this.floatingWindow.style.margin="",this.floatingWindow.style.padding="",this.floatingWindow.style.zIndex="",this.floatingWindow.classList.add("floating-mode"),this.floatingWindow.classList.contains("show")||this.floatingWindow.classList.add("show"),requestAnimationFrame(()=>{this.floatingWindow&&(this.floatingWindow.classList.add("show"),this.floatingWindow.style.display="flex",this.floatingWindow.style.opacity="1",this.floatingWindow.style.visibility="visible")}),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",this.clearWeixinDocsSpecificStyles(),this.updateDockButtonIcon(!1),this.isDocked=!1,this.isWindowOpen=!0,setTimeout(()=>{this.recalculateIframeSize()},100))}applyWeixinDocsSpecificStyles(){["#app",".page-container",".doc-container",".main-container",".main-content",".doc-content",".content-wrapper",'[class*="layout"]','[class*="page-"]','[class*="container"]'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{"senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id&&(t.style.setProperty("margin-right","0","important"),t.style.setProperty("width","100%","important"),t.style.setProperty("max-width","100%","important"),t.style.setProperty("box-sizing","border-box","important"))})});document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]').forEach(t=>{if("senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id){t.getBoundingClientRect().right>.6*window.innerWidth&&t.style.setProperty("right","40%","important")}})}clearWeixinDocsSpecificStyles(){["#app",".page-container",".doc-container",".main-container",".main-content",".doc-content",".content-wrapper",'[class*="layout"]','[class*="page-"]','[class*="container"]'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{"senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id&&(t.style.marginRight="",t.style.width="",t.style.maxWidth="",t.style.boxSizing="")})})}updateDockButtonIcon(t){const i=this.floatingWindow?.querySelector("#dock-toggle-button");i&&(t?(i.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <rect x="5" y="5" width="14" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n          <path d="M9 1v4M15 1v4M9 19v4M15 19v4M1 9h4M1 15h4M19 9h4M19 15h4" stroke="currentColor" stroke-width="2"/>\n        </svg>\n      ',i.title="切换到悬浮模式"):(i.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n          <path d="M9 3v18" stroke="currentColor" stroke-width="2"/>\n        </svg>\n      ',i.title="切换到停靠模式"))}recalculateIframeSize(){if(!this.floatingWindow)return;const t=this.floatingWindow.querySelector("#senparc-ai-iframe"),i=this.floatingWindow.querySelector(".floating-window-content");if(t&&i){i.style.display="none",i.offsetHeight,i.style.display="flex";const o=i.getBoundingClientRect();t.style.width=o.width+"px",t.style.height=o.height+"px",t.style.display="block",t.style.visibility="visible"}}closeFloatingWindow(){if(this.floatingWindow){this.isWindowOpen=!1;try{this.isDocked&&(document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",this.clearWeixinDocsSpecificStyles(),this.isDocked=!1),this.floatingWindow.style.display="none",this.floatingWindow.style.opacity="0",this.floatingWindow.style.visibility="hidden",this.floatingWindow.classList.remove("show","floating-mode","docked-mode"),setTimeout(()=>{if(this.floatingWindow){const t=this.floatingWindow.querySelector("#senparc-ai-iframe");t&&(t.style.display="block")}},100)}catch(t){this.floatingWindow&&(this.floatingWindow.style.display="none",this.floatingWindow.style.opacity="0"),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",this.isDocked=!1}}else this.isWindowOpen=!1}destroy(){this.isDocked&&this.setFloatingMode(),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",this.clearWeixinDocsSpecificStyles(),this.logoButton&&(this.logoButton.remove(),this.logoButton=null),this.floatingWindow&&(this.floatingWindow.remove(),this.floatingWindow=null),this.isWindowOpen=!1,this.isDocked=!1;document.querySelectorAll("#senparc-weixin-ai-button").forEach(t=>{t.remove()});document.querySelectorAll("#senparc-weixin-ai-window").forEach(t=>{t.remove()})}}let globalAssistantInstance=null;function initializeAssistant(){globalAssistantInstance&&(globalAssistantInstance.destroy(),globalAssistantInstance=null);try{globalAssistantInstance=new WeixinAIAssistant}catch(t){}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeAssistant):initializeAssistant();let lastUrl=location.href,urlChangeTimeout=null;function setupHistoryAPIDetection(){const t=history.pushState,i=history.replaceState;function o(){PerformanceMonitor.recordHistoryApiCall();const t=location.href;t!==lastUrl&&(lastUrl=t,PerformanceMonitor.recordUrlChange(),URL_DETECTION_CONFIG.enableDebugLog,urlChangeTimeout&&clearTimeout(urlChangeTimeout),urlChangeTimeout=setTimeout(()=>{initializeAssistant()},URL_DETECTION_CONFIG.debounceDelay))}history.pushState=function(...i){t.apply(history,i),o()},history.replaceState=function(...t){i.apply(history,t),o()},window.addEventListener("popstate",o),window.addEventListener("hashchange",o)}function setupOptimizedMutationObserver(){let t=null;new MutationObserver(function(){PerformanceMonitor.recordMutationObserverCall(),t||(t=setTimeout(()=>{const i=location.href;i!==lastUrl&&(lastUrl=i,PerformanceMonitor.recordUrlChange(),URL_DETECTION_CONFIG.enableDebugLog,urlChangeTimeout&&clearTimeout(urlChangeTimeout),urlChangeTimeout=setTimeout(()=>{initializeAssistant()},URL_DETECTION_CONFIG.debounceDelay)),t=null},URL_DETECTION_CONFIG.throttleDelay))}).observe(document.body,{childList:!0,subtree:!1})}const URL_DETECTION_CONFIG={method:"history",debounceDelay:500,throttleDelay:100,enableDebugLog:!0};function initUrlDetection(){switch(URL_DETECTION_CONFIG.method){case"history":default:setupHistoryAPIDetection();break;case"mutation":setupOptimizedMutationObserver();break;case"hybrid":setupHistoryAPIDetection(),setupOptimizedMutationObserver()}}const PerformanceMonitor={stats:{historyApiCalls:0,mutationObserverCalls:0,urlChanges:0,lastUrlChangeTime:0},recordHistoryApiCall(){this.stats.historyApiCalls++},recordMutationObserverCall(){this.stats.mutationObserverCalls++},recordUrlChange(){this.stats.urlChanges++,this.stats.lastUrlChangeTime=Date.now()},getStats(){return{...this.stats}},reset(){this.stats={historyApiCalls:0,mutationObserverCalls:0,urlChanges:0,lastUrlChangeTime:0}},logStats(){}};window.UrlDetectionPerformanceMonitor=PerformanceMonitor,initUrlDetection(),URL_DETECTION_CONFIG.enableDebugLog&&setInterval(()=>{PerformanceMonitor.logStats()},3e4),window.WeixinAIAssistant=WeixinAIAssistant,window.initializeAssistant=initializeAssistant,Object.defineProperty(window,"globalAssistantInstance",{get:()=>globalAssistantInstance});