window.__SENPARC_DEBUG__={enabled:!1,level:"error",trigger:"senparc-debug"},function(){const t=new URLSearchParams(window.location.search),i=new URLSearchParams(window.location.hash.substring(1));window.__SENPARC_DEBUG__={enabled:t.has("senparc_debug_mode")||i.has("senparc_debug_mode")||window.location.href.includes("senparc_debug_mode=true"),level:"error",trigger:"senparc_debug_mode=true"}}();class WeixinAIAssistant{constructor(){this.logoButton=null,this.floatingWindow=null,this.isWindowOpen=!1,this.isDocked=!1,this.originalBodyStyle="",this.debug=window.__SENPARC_DEBUG__||{enabled:!1,level:"error",trigger:"senparc-debug"},this.init()}log(t,...i){(this.debug.enabled||window.location.href.includes(this.debug.trigger))&&("verbose"===this.debug.level||"info"===this.debug.level&&"verbose"!==t||"warn"===this.debug.level&&("warn"===t||"error"===t)||this.debug.level)}init(){this.log("info","Senparc.Weixin.AI 插件开始初始化..."),this.log("verbose","当前页面URL:",window.location.href),this.log("verbose","当前域名:",window.location.hostname),this.isWeixinDocPage()?(this.log("info","✅ 检测到微信文档页面，初始化AI助手..."),this.createLogoButton(),this.setupEventListeners()):(this.log("warn","❌ 当前页面不在支持列表中"),this.log("info","仅支持以下页面:"),this.log("info","  - https://developers.weixin.qq.com/"),this.log("info","  - https://developer.work.weixin.qq.com/document"),this.log("info","  - https://pay.weixin.qq.com/doc"))}isWeixinDocPage(){const t=window.location.href,i=window.location.hostname,n=["developers.weixin.qq.com","developer.work.weixin.qq.com","pay.weixin.qq.com"].some(t=>i===t);return"developer.work.weixin.qq.com"===i?t.includes("/document"):"pay.weixin.qq.com"===i?t.includes("/doc"):n}createLogoButton(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;const t=document.getElementById("senparc-weixin-ai-button");t&&(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.remove()),this.logoButton=document.createElement("div"),this.logoButton.id="senparc-weixin-ai-button",this.logoButton.className="senparc-ai-logo-button",this.logoButton.innerHTML='\n      <div class="logo-content">\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n        </svg>\n        <span class="logo-text">Senparc.Weixin.AI</span>\n      </div>\n    ',document.body.appendChild(this.logoButton),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.setupDragFeature()}setupDragFeature(){if(!this.logoButton)return;let t,i,n,o,e,s,a=!1,_=!1,d=0,l=0,r=0;const w=localStorage.getItem("senparcAiButtonPosition");if(w)try{const{x:t,y:i}=JSON.parse(w);this.logoButton.style.left=t+"px",this.logoButton.style.top=i+"px",l=t,r=i}catch(t){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}const c=l=>{if(l.target===this.logoButton||this.logoButton.contains(l.target)){a=!0,_=!1,d=Date.now(),n=this.logoButton.offsetWidth,o=this.logoButton.offsetHeight,e=window.innerWidth-n,s=window.innerHeight-o;const r=parseInt(this.logoButton.style.left)||0,w=parseInt(this.logoButton.style.top)||0;"mousedown"===l.type?(t=l.clientX-r,i=l.clientY-w):(t=l.touches[0].clientX-r,i=l.touches[0].clientY-w),this.logoButton.classList.add("dragging"),this.logoButton.style.cursor="grabbing",l.preventDefault(),l.stopPropagation()}},h=t=>{if(!a)return;const i=Date.now()-d;a=!1,this.logoButton.classList.remove("dragging"),this.logoButton.style.cursor="grab",(_||i>200)&&(t.preventDefault(),t.stopPropagation(),this.logoButton.setAttribute("data-just-dragged","true"),setTimeout(()=>{this.logoButton.removeAttribute("data-just-dragged")},100),this._savePositionTimeout&&clearTimeout(this._savePositionTimeout),this._savePositionTimeout=setTimeout(()=>{localStorage.setItem("senparcAiButtonPosition",JSON.stringify({x:l,y:r}))},500))},g=n=>{if(!a)return;n.preventDefault(),n.stopPropagation();const o="mousemove"===n.type?n.clientX:n.touches[0].clientX,d="mousemove"===n.type?n.clientY:n.touches[0].clientY;let w=Math.min(Math.max(0,o-t),e),c=Math.min(Math.max(0,d-i),s);!_&&(Math.abs(w-l)>5||Math.abs(c-r)>5)&&(_=!0),w!==l&&(this.logoButton.style.left=w+"px",l=w),c!==r&&(this.logoButton.style.top=c+"px",r=c)};this.logoButton.addEventListener("mousedown",c,{capture:!0}),document.addEventListener("mousemove",g,{capture:!0}),document.addEventListener("mouseup",h,{capture:!0}),this.logoButton.addEventListener("touchstart",c,{capture:!0,passive:!1}),document.addEventListener("touchmove",g,{capture:!0,passive:!1}),document.addEventListener("touchend",h,{capture:!0}),this.logoButton.style.position="fixed",this.logoButton.style.cursor="grab",this.logoButton.style.userSelect="none",this.logoButton.style.zIndex="10000",this.logoButton.style.touchAction="none"}setupEventListeners(){if(this.logoButton){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.logoButton.onclick=null;const t=t=>{"true"!==this.logoButton.getAttribute("data-just-dragged")&&(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.preventDefault(),t.stopPropagation(),this.toggleFloatingWindow())};this.logoButton.addEventListener("click",t,{capture:!0}),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}else window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;document.addEventListener("keydown",t=>{"Escape"===t.key&&this.isWindowOpen&&this.closeFloatingWindow()}),document.addEventListener("click",t=>{this.isWindowOpen&&this.floatingWindow&&!this.floatingWindow.contains(t.target)&&!this.logoButton.contains(t.target)&&this.closeFloatingWindow()})}toggleFloatingWindow(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.isWindowOpen?(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.closeFloatingWindow()):(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.openFloatingWindow()),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}openFloatingWindow(){if(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow.style.display="flex",this.floatingWindow.style.opacity="1",this.floatingWindow.style.visibility="visible",this.floatingWindow.classList.add("floating-mode"),this.isWindowOpen=!0;const t=this.floatingWindow.querySelector("#senparc-ai-iframe"),i=this.floatingWindow.querySelector(".loading-indicator");if(t){t.style.cssText="\n          width: 100% !important;\n          height: 100% !important;\n          border: none;\n          display: block !important;\n          min-height: 500px;\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n        ";const i=t.parentElement;if(i){const n=i.offsetHeight,o=i.offsetWidth;window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.style.width=o+"px",t.style.height=n+"px"}t.style.opacity="0",setTimeout(()=>{t.style.opacity="1"},50),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}return i&&(i.style.display="none",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled),this.setupButtonEvents(),requestAnimationFrame(()=>{this.floatingWindow&&(this.floatingWindow.classList.add("show"),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setTimeout(()=>{this.recalculateIframeSize()},350))}),void(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled)}this.floatingWindow=document.createElement("div"),this.floatingWindow.id="senparc-weixin-ai-window",this.floatingWindow.className="senparc-ai-floating-window";const t=encodeURIComponent(window.location.href);this.floatingWindow.innerHTML=`\n      <div class="floating-window-header">\n        <div class="window-title">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n          </svg>\n          Senparc.Weixin.AI 助手\n        </div>\n        <div class="window-controls">\n          <button class="dock-button" id="dock-toggle-button" title="停靠/悬浮切换">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n              <path d="M9 3v18" stroke="currentColor" stroke-width="2"/>\n            </svg>\n          </button>\n          <button class="close-button" id="close-floating-window">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n      <div class="floating-window-content">\n        <div class="loading-indicator">\n          <div class="spinner"></div>\n          <p>正在加载AI助手...</p>\n        </div>\n        <iframe \n          id="senparc-ai-iframe" \n          src="https://sdk.weixin.senparc.com/AiDoc?query=${t}" \n          frameborder="0"\n          allow="clipboard-read; clipboard-write"\n          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation">\n        </iframe>\n      </div>\n      <div class="floating-window-footer">\n        <span class="footer-text">Powered by Senparc.Weixin SDK</span>\n      </div>\n    `,document.body.appendChild(this.floatingWindow),this.floatingWindow.classList.add("floating-mode"),this.setupButtonEvents();const i=new ResizeObserver(()=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.recalculateIframeSize()}),n=this.floatingWindow.querySelector(".floating-window-content");n&&i.observe(n);const o=this.floatingWindow.querySelector("#senparc-ai-iframe");o.addEventListener("load",()=>{const t=this.floatingWindow.querySelector(".loading-indicator");t&&(t.style.display="none"),o.style.display="block",setTimeout(()=>{this.recalculateIframeSize()},100),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}),o.addEventListener("error",()=>{const t=this.floatingWindow.querySelector(".loading-indicator");t&&(t.innerHTML='\n          <div class="error-message">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>\n              <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n            <p>加载失败，请检查网络连接</p>\n            <button onclick="location.reload()" class="retry-button">重试</button>\n          </div>\n        ')}),this.isWindowOpen=!0,setTimeout(()=>{this.floatingWindow.classList.add("show")},10)}setupButtonEvents(){this.floatingWindow?(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.bindButtonEvents(),this.isButtonEventsBound()||(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setTimeout(()=>{this.bindButtonEvents()},50))):window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}isButtonEventsBound(){const t=this.floatingWindow?.querySelector("#close-floating-window");return t&&"function"==typeof t.onclick}bindButtonEvents(){if(!this.floatingWindow)return void(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled);window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;const t=this.floatingWindow.querySelector("#close-floating-window");if(!t)return window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,void setTimeout(()=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.bindButtonEvents()},200);{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;const i=t=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t&&(t.preventDefault(),t.stopPropagation());try{this.closeFloatingWindow(),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}catch(t){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}return!1};t.onclick=i,t.addEventListener("click",i,{capture:!0,once:!1}),t.addEventListener("mousedown",t=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.preventDefault(),setTimeout(()=>i(t),10)}),t.style.cssText="\n        pointer-events: auto !important;\n        cursor: pointer !important;\n        z-index: 10003 !important;\n        position: relative !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border: none !important;\n        border-radius: 8px !important;\n        width: 32px !important;\n        height: 32px !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        color: white !important;\n      ",t.setAttribute("data-event-bound","true"),t.setAttribute("data-bind-time",Date.now().toString()),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}const i=this.floatingWindow.querySelector("#dock-toggle-button");if(i){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;const t=t=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t&&(t.preventDefault(),t.stopPropagation());try{this.toggleDockMode(),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}catch(t){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}return!1};i.onclick=t,i.addEventListener("click",t,{capture:!0}),i.style.cssText="\n        pointer-events: auto !important;\n        cursor: pointer !important;\n        z-index: 10003 !important;\n        position: relative !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border: none !important;\n        border-radius: 8px !important;\n        width: 32px !important;\n        height: 32px !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        color: white !important;\n        margin-right: 4px !important;\n      ",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}else window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}toggleDockMode(){this.isDocked?this.setFloatingMode():this.setDockMode()}setDockMode(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow&&(this.originalBodyStyle=document.body.className,this.floatingWindow.classList.remove("show","floating-mode"),this.floatingWindow.style.transform="none !important",this.floatingWindow.style.left="auto !important",this.floatingWindow.style.top="0 !important",this.floatingWindow.style.right="0 !important",this.floatingWindow.style.width="40% !important",this.floatingWindow.style.height="100vh !important",this.floatingWindow.style.maxWidth="none !important",this.floatingWindow.style.maxHeight="none !important",this.floatingWindow.style.minHeight="100vh !important",this.floatingWindow.style.borderRadius="0 !important",this.floatingWindow.style.position="fixed !important",this.floatingWindow.style.display="flex !important",this.floatingWindow.style.opacity="1 !important",this.floatingWindow.style.visibility="visible !important",this.floatingWindow.style.zIndex="10000 !important",this.floatingWindow.classList.add("docked-mode"),requestAnimationFrame(()=>{this.floatingWindow.classList.add("show")}),document.body.classList.add("senparc-docked"),document.body.style.marginRight="40%",document.body.style.transition="margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.boxSizing="border-box",document.body.style.overflowX="hidden",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.applyWeixinDocsSpecificStyles(),this.updateDockButtonIcon(!0),this.isDocked=!0,this.isWindowOpen=!0,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setTimeout(()=>{this.recalculateIframeSize()},100))}setFloatingMode(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow&&(this.floatingWindow.style.display="flex !important",this.floatingWindow.style.opacity="1 !important",this.floatingWindow.style.visibility="visible !important",this.floatingWindow.classList.remove("docked-mode"),this.floatingWindow.style.transform="",this.floatingWindow.style.left="",this.floatingWindow.style.top="",this.floatingWindow.style.right="",this.floatingWindow.style.width="",this.floatingWindow.style.height="",this.floatingWindow.style.maxWidth="",this.floatingWindow.style.maxHeight="",this.floatingWindow.style.minHeight="",this.floatingWindow.style.borderRadius="",this.floatingWindow.style.position="",this.floatingWindow.style.margin="",this.floatingWindow.style.padding="",this.floatingWindow.style.zIndex="",this.floatingWindow.classList.add("floating-mode"),this.floatingWindow.classList.contains("show")||this.floatingWindow.classList.add("show"),requestAnimationFrame(()=>{this.floatingWindow&&(this.floatingWindow.classList.add("show"),this.floatingWindow.style.display="flex",this.floatingWindow.style.opacity="1",this.floatingWindow.style.visibility="visible")}),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.clearWeixinDocsSpecificStyles(),this.updateDockButtonIcon(!1),this.isDocked=!1,this.isWindowOpen=!0,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setTimeout(()=>{this.recalculateIframeSize()},100))}applyWeixinDocsSpecificStyles(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;["#app",".page-container",".doc-container",".main-container",".main-content",".doc-content",".content-wrapper",'[class*="layout"]','[class*="page-"]','[class*="container"]'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{"senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id&&(t.style.setProperty("margin-right","0","important"),t.style.setProperty("width","100%","important"),t.style.setProperty("max-width","100%","important"),t.style.setProperty("box-sizing","border-box","important"))})});document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]').forEach(t=>{if("senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id){t.getBoundingClientRect().right>.6*window.innerWidth&&t.style.setProperty("right","40%","important")}}),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}clearWeixinDocsSpecificStyles(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled;["#app",".page-container",".doc-container",".main-container",".main-content",".doc-content",".content-wrapper",'[class*="layout"]','[class*="page-"]','[class*="container"]'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{"senparc-weixin-ai-window"!==t.id&&"senparc-weixin-ai-button"!==t.id&&(t.style.marginRight="",t.style.width="",t.style.maxWidth="",t.style.boxSizing="")})}),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}updateDockButtonIcon(t){const i=this.floatingWindow?.querySelector("#dock-toggle-button");i&&(t?(i.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <rect x="5" y="5" width="14" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n          <path d="M9 1v4M15 1v4M9 19v4M15 19v4M1 9h4M1 15h4M19 9h4M19 15h4" stroke="currentColor" stroke-width="2"/>\n        </svg>\n      ',i.title="切换到悬浮模式"):(i.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>\n          <path d="M9 3v18" stroke="currentColor" stroke-width="2"/>\n        </svg>\n      ',i.title="切换到停靠模式"))}recalculateIframeSize(){if(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,!this.floatingWindow)return;const t=this.floatingWindow.querySelector("#senparc-ai-iframe"),i=this.floatingWindow.querySelector(".floating-window-content");if(t&&i){i.style.display="none",i.offsetHeight,i.style.display="flex";const n=i.getBoundingClientRect();window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.style.width=n.width+"px",t.style.height=n.height+"px",t.style.display="block",t.style.visibility="visible",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}}closeFloatingWindow(){if(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,!this.floatingWindow)return window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,void(this.isWindowOpen=!1);this.isWindowOpen=!1;try{this.isDocked&&(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",this.clearWeixinDocsSpecificStyles(),this.isDocked=!1,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow.style.display="none",this.floatingWindow.style.opacity="0",this.floatingWindow.style.visibility="hidden",this.floatingWindow.classList.remove("show","floating-mode","docked-mode"),window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setTimeout(()=>{if(this.floatingWindow){const t=this.floatingWindow.querySelector("#senparc-ai-iframe");t&&(t.style.display="block",window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled)}},100)}catch(t){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.floatingWindow&&(this.floatingWindow.style.display="none",this.floatingWindow.style.opacity="0"),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",this.isDocked=!1}window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}destroy(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,this.isDocked&&this.setFloatingMode(),document.body.classList.remove("senparc-docked"),document.body.style.marginRight="",document.body.style.transition="",document.body.style.boxSizing="",document.body.style.overflowX="",this.clearWeixinDocsSpecificStyles(),this.logoButton&&(this.logoButton.remove(),this.logoButton=null),this.floatingWindow&&(this.floatingWindow.remove(),this.floatingWindow=null),this.isWindowOpen=!1,this.isDocked=!1;document.querySelectorAll("#senparc-weixin-ai-button").forEach(t=>{window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,t.remove()});document.querySelectorAll("#senparc-weixin-ai-window").forEach(t=>{t.__SENPARC_DEBUG__&&t.__SENPARC_DEBUG__.enabled,t.remove()})}}let globalAssistantInstance=null;function initializeAssistant(){globalAssistantInstance&&(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,globalAssistantInstance.destroy(),globalAssistantInstance=null);try{globalAssistantInstance=new WeixinAIAssistant,window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}catch(t){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeAssistant):initializeAssistant();let lastUrl=location.href,urlChangeTimeout=null;function setupHistoryAPIDetection(){const t=history.pushState,i=history.replaceState;function n(){PerformanceMonitor.recordHistoryApiCall();const t=location.href;t!==lastUrl&&(lastUrl=t,PerformanceMonitor.recordUrlChange(),URL_DETECTION_CONFIG.enableDebugLog&&window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,urlChangeTimeout&&clearTimeout(urlChangeTimeout),urlChangeTimeout=setTimeout(()=>{initializeAssistant()},URL_DETECTION_CONFIG.debounceDelay))}history.pushState=function(...i){t.apply(history,i),n()},history.replaceState=function(...t){i.apply(history,t),n()},window.addEventListener("popstate",n),window.addEventListener("hashchange",n)}function setupOptimizedMutationObserver(){let t=null;new MutationObserver(function(){PerformanceMonitor.recordMutationObserverCall(),t||(t=setTimeout(()=>{const i=location.href;i!==lastUrl&&(lastUrl=i,PerformanceMonitor.recordUrlChange(),URL_DETECTION_CONFIG.enableDebugLog&&window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,urlChangeTimeout&&clearTimeout(urlChangeTimeout),urlChangeTimeout=setTimeout(()=>{initializeAssistant()},URL_DETECTION_CONFIG.debounceDelay)),t=null},URL_DETECTION_CONFIG.throttleDelay))}).observe(document.body,{childList:!0,subtree:!1})}const URL_DETECTION_CONFIG={method:"history",debounceDelay:500,throttleDelay:100,enableDebugLog:!0};function initUrlDetection(){switch(window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,URL_DETECTION_CONFIG.method){case"history":setupHistoryAPIDetection();break;case"mutation":setupOptimizedMutationObserver();break;case"hybrid":setupHistoryAPIDetection(),setupOptimizedMutationObserver();break;default:window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled,setupHistoryAPIDetection()}}const PerformanceMonitor={stats:{historyApiCalls:0,mutationObserverCalls:0,urlChanges:0,lastUrlChangeTime:0},recordHistoryApiCall(){this.stats.historyApiCalls++},recordMutationObserverCall(){this.stats.mutationObserverCalls++},recordUrlChange(){this.stats.urlChanges++,this.stats.lastUrlChangeTime=Date.now()},getStats(){return{...this.stats}},reset(){this.stats={historyApiCalls:0,mutationObserverCalls:0,urlChanges:0,lastUrlChangeTime:0}},logStats(){window.__SENPARC_DEBUG__&&window.__SENPARC_DEBUG__.enabled}};window.UrlDetectionPerformanceMonitor=PerformanceMonitor,initUrlDetection(),URL_DETECTION_CONFIG.enableDebugLog&&setInterval(()=>{PerformanceMonitor.logStats()},3e4),window.WeixinAIAssistant=WeixinAIAssistant,window.initializeAssistant=initializeAssistant,Object.defineProperty(window,"globalAssistantInstance",{get:()=>globalAssistantInstance});